<!DOCTYPE HTML>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" language="javascript"></script>
    <script src="../js/cloudmine.js" language="javascript"></script>
    <script language="javascript">
      $(document).ready(function() {
          var appid = "ae44751608f0431989b26a5943500596";
          var apikey = "d5f3bfe83d7041889bd1b072bdba101e";

          cloudmine.init({app_id: appid, api_key: apikey});

          $('#message').bind('keydown', function(event) {
              // Only bind to the return/enter key being pressed.
              if(event.which == 13) {
                  // Construct some sort of unique identifier
                  // (in this case, we are using the UNIX timestamp).
                  var key = new Date().getTime();

                  // This is our data model.
                  // Basically just store the person's name and their message in a JSON object.
                  var data = { 'message': $('#message').val(), 'name': $('#name').val() };

                  // Call the CloudMine API to actually push the data to the CM servers.
                  cloudmine.updateValue(key, data, function(){
                      cloudmine.log("Saved: " + key + ": " + data);
                  });

                  // Clear the message box.
                  $('#message').val('');
              }
          });

          // Setup polling of the CloudMine servers to update the chat box.
          var updateChat = function(){
              // Call the CloudMine API to grab all the data from the server. In this case
              // we want to get all the keys since they represent all the messages.
              var chat = '';
              cloudmine.getValues(null, {
                  success: function(success) {
                      // Basic string concatination to build the string
                      // to display to the user in the chat box.
                      success.forEach(function(key, value){
                          chat += value.name + ': ' + value.message + "\n";
                      });

                      // Show the assembled string in the chat box.
                      $('#chat').val(chat);
                  }
              });
          }

          updateChat();
          setInterval(updateChat, 1000);
      });
    </script>
  </head>
  <body>
    <textarea id="chat" cols="60" rows="20"></textarea>
    <p>Name: <input type="text" id="name" /> Message: <input type="text" id="message" /></p>
  </body>
</html>
